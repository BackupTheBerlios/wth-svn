head	1.1;
access;
symbols;
locks
	jahns:1.1; strict;
comment	@ * @;


1.1
date	2002.07.04.09.51.48;	author jahns;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Initial revision
@
text
@/* wthc.c

   client program to communicate w/ WS2000 weatherstation

   $Id: wthc.c,v 0.4 2001/09/14 15:38:00 jahns Exp jahns $
   $Revision: 0.4 $
   
   Copyright (C) 2000-2001 Volker Jahns <Volker.Jahns@@thalreit.de>

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111, USA.
 
*/

#include "wth.h"
#include "config.h"

int main (int argc, char **argv) {
  int o;
  int stime = 0;
  char *rbuf;
  extern int optind;              
  extern char *optarg;
  struct cmd cmd;                 /* command structure */
  struct wthio wio;               /* result */

  initdata(&wio);
  initcmd(&cmd);
  if ( ( rbuf = readconfig(&cmd)) == NULL ) {
	perror("Error reading configuration: exit!");
	exit(-1);
  }
  
  openlog("wthc", LOG_PID , cmd.logfacility);
  syslog(LOG_INFO, "wthc: %s\n", VERSION);
                                                                    
  /* parsing command line arguments */
  while (( o = getopt(argc, argv, "c:h:i:p:stv")) != -1 ) {
    switch (o) {
    case 'c':
      cmd.command = atoi(optarg);
      break;
    case 'h':
      cmd.hostname = optarg;
      cmd.netflg = 1;
      break;
    case 'i':
      cmd.argcmd = atoi(optarg);
      break;
    case 'p':
      cmd.port = optarg;
      break;
    case 's':
      if ( cmd.netflg != -1 )
	usage(1,"specify serial OR internet connection","");
      cmd.netflg = 0;
      break;
    case 't':
      stime = 1;
      break;
    case 'v':
      cmd.verbose = 1;
      printf("wthc version: %s\n", VERSION);
      printf("%s", rbuf);
      break;
    case '?':
      usage(1, "Commandline error", "");
      break;
    default:
      usage(0,"", "");
    }
  }

  /* save command for later use */
  o = cmd.command;

  /* check if intervall time has been set 
     in case cmd.command is request to set intervall time */
  if ( cmd.command == 6 ) {
      if ((cmd.argcmd < 1) || (cmd.argcmd >60))
	  usage(1,"interval time not been specified or out of range", "");
  }

  /* check on serial/internet connection is been chosen correctly */
  if ( cmd.netflg == -1 )
      usage(1, "specify serial OR internet connection","");

  if (cmd.verbose == 1 ) {
	if ( ( rbuf = echoconfig(&cmd)) == NULL) {
	  perror("Error echo config parameters: exit!");
	  exit(-1);
	}
	printf("%s\n", rbuf);
  }
  
  /* sending command to weather station */  
  rbuf =  wcmd(&cmd, &wio); 
  printf("%s", rbuf);
  /* syslog(LOG_INFO, "wthc : wcmd : %s\n", c(o)->descr); */

  if ( stime == 1 ) {
      if ( settime(&wio) == -1 ) 
	perror("Can't set time");
  }

  switch (werrno) {
  case -2:
	printf("serial line error\n");
	break;
  case -3:
    printf("chksum error\n");
	break;
  case 0:
	break;
  }

  closelog();
  return(0);

} 



@
